# mcp-joke-server

Simple Model Context Protocol (MCP) tools server that exposes joke-related tools. It fetches jokes from an external HTTP API and provides them to MCP-compatible clients via the FastMCP framework. Multiple transports are supported via a Strategy pattern: stdio (default), HTTP, and SSE.

## Overview

This repository implements an MCP server using `fastmcp`. The server defines four tools:

- `tool_get_consistent_joke()` — returns the same hardcoded joke every time.
- `tool_get_joke()` — fetches a random joke from an external jokes API.
- `tool_get_joke_by_id(joke_id)` — fetches a joke by numeric ID.

- `tool_get_joke_by_type(joke_type)` — fetches a joke by category (`general`, `knock-knock`, `programming`, `dad`).

Additionally, there are asynchronous variants of the networked tools useful for async client workflows:

- `tool_aget_joke()`
- `tool_aget_joke_by_id(joke_id)`
- `tool_aget_joke_by_type(joke_type)`

The external API base URL is configured via the `API_BASE_URL` environment variable (see Environment Variables). The server transport is selected with `MCP_PROTOCOL` (`stdio`, `http`, or `sse`).

## Stack

- Language: Python (requires Python 3.13+ per `pyproject.toml`)
- MCP framework: `fastmcp`
- HTTP client: `httpx`
- Models/validation: `pydantic`, `pydantic-settings` (plus simple dataclasses)
- Env loading: `pydantic-settings` + `python-dotenv` (para `.env`)
- Logging/UX: `loguru`, `rich`
- Package manager: `uv` (detected via `uv.lock`) — `pip` also works
- Entry point: `main.py` (starts FastMCP and registers tools)

## Requirements

- Python 3.13 or newer
- `uv` (recommended) or `pip`
- Network access to the configured jokes API (`API_BASE_URL`)

## Project Structure

```
.
├── LICENSE
├── README.md
├── main.py                     # MCP server entry point (starts FastMCP)
├── pyproject.toml              # Project metadata and dependencies
├── uv.lock                     # uv lockfile
├── repositories/               # Repository pattern (HTTP + cached repositories)
│   ├── base.py
│   ├── cached_repository.py
│   ├── factory.py
│   ├── http_repository.py
│   └── __init__.py
├── strategies/                 # Strategy pattern for MCP transports (stdio/http/sse)
│   ├── base.py
│   ├── factory.py
│   ├── http_strategy.py
│   ├── sse_strategy.py
│   ├── stdio_strategy.py
│   └── __init__.py
├── utils/
│   ├── RequestAPIJokes.py      # HTTP client for the jokes API
│   ├── config.py               # Configuration via pydantic-settings
│   ├── constants.py            # URL, joke types, consistent joke
│   ├── exceptions.py
│   ├── formatters.py           # helpers (e.g., extract_joke)
│   ├── logger.py
│   ├── logging_config.py       # logging formatter/handlers configuration helpers
│   ├── logging_interfaces.py   # protocol-style interfaces for logging plumbing
│   ├── rich_renderers.py       # rich render helpers
│   └── model.py                # dataclasses for Joke/Jokes
├── tests/                      # Pytest suite and config
│   ├── conftest.py
│   ├── test_cached_repository.py
│   ├── test_config.py
│   ├── test_exceptions.py
│   ├── test_factory.py
│   ├── test_integration.py
│   ├── test_main_tools.py
│   └── test_repositories_base.py
├── docs/                       # Documentation index and guides
│   ├── TESTING_GUIDE.md
│   ├── REPOSITORY_ARCHITECTURE.md
│   └── ...
├── examples/
│   ├── mcp_client.py           # demo MCP client
│   └── repository_pattern_demo.py
├── logs/
│   ├── mcp_server.log          # runtime log (default)
│   └── errors.log              # optional error logs
└── htmlcov/                    # coverage HTML report (generated by pytest-cov)
```

## Environment Variables

Configuration is loaded using `pydantic-settings` and supports `.env` files.

Required:

- `API_BASE_URL` — Base URL of the jokes API.
  - Canonical example provider: `https://official-joke-api.appspot.com`
  - Endpoints used by `utils/RequestAPIJokes.py`:
    - `/random_joke`
    - `/random_ten`
    - `/jokes/{id}`
    - `/jokes/{type}/random`

Optional (defaults defined in `utils/config.py`):

- `MCP_PROTOCOL` (default: `stdio`) — transport selection for the MCP server; accepted values: `stdio`, `http`, or `sse`
- `MCP_SERVER_HOST` (default: `0.0.0.0`) — host for HTTP/SSE transports
- `MCP_SERVER_PORT` (default: `8000`) — port for HTTP/SSE transports
- `LOG_LEVEL` (default: `INFO`)
- `LOG_FILE` (default: `logs/mcp_server.log`)
- `LOG_ROTATION` (default: `10 MB`)
- `LOG_RETENTION` (default: `7 days`)
- `SESSION_TIMEOUT` (default: `3600`)
- `SESSION_CLEANUP_INTERVAL` (default: `300`)

Example `.env`:

```
API_BASE_URL=https://official-joke-api.appspot.com
MCP_PROTOCOL=stdio  # Options: "stdio" (default), "http", or "sse"
MCP_SERVER_HOST=0.0.0.0  # Only used for http/sse transports
MCP_SERVER_PORT=8000     # Only used for http/sse transports
LOG_LEVEL=INFO
```

Notes about configuration:

- `utils/constants.py` binds `URL = Settings.API_BASE_URL` at import time. Ensure the `API_BASE_URL` environment variable is set before importing modules that rely on it (e.g., in tests and ad‑hoc scripts).
- `Settings` en `utils/config.py` carga valores desde variables de entorno y archivos `.env` usando `pydantic-settings` (con soporte de `python-dotenv`).

## Setup

Using uv (recommended):

```
uv sync
```

Or with pip:

```
python -m venv .venv
. .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -e .
```

## Run

The server entry point is `main.py`. Transport is selected by `MCP_PROTOCOL`:

- `stdio` (default for many MCP clients): runs MCP over stdio
- `http`: runs MCP over FastMCP's `streamable-http` transport
- `sse`: runs MCP over Server-Sent Events (unidirectional stream over HTTP)

Using uv (stdio):

```
MCP_PROTOCOL=stdio uv run python main.py
```

Using uv (HTTP):

```
MCP_PROTOCOL=http uv run python main.py  # uses Settings.MCP_SERVER_HOST/PORT
```

Using uv (SSE):

```
MCP_PROTOCOL=sse uv run python main.py   # uses Settings.MCP_SERVER_HOST/PORT
```

Using pip/venv:

```
# stdio
MCP_PROTOCOL=stdio python main.py

# http
MCP_PROTOCOL=http python main.py

# sse
MCP_PROTOCOL=sse python main.py
```

Notes:

- For stdio, configure your MCP client to launch the command above as a subprocess.
- For HTTP/SSE, the server will bind to `MCP_SERVER_HOST:MCP_SERVER_PORT` using FastMCP's `streamable-http` or SSE transport.

## Available Tools (MCP)

Defined in `main.py`:

- `tool_get_consistent_joke() -> str`
- `tool_get_joke() -> str`
- `tool_get_joke_by_id(joke_id: int) -> str` (valid range 1–451)
- `tool_get_joke_by_type(joke_type: Literal["general", "knock-knock", "programming", "dad"]) -> str`

Implementation uses the Repository Pattern (`repositories/*`). HTTP access and error mapping live in `utils/RequestAPIJokes.py`, and results are formatted with `utils/formatters.extract_joke`.

Repository defaults:

- The factory (`repositories/factory.py`) returns a cached repository by default for better performance. You can swap implementations without changing tool code.

Asynchronous variants (useful for async workflows):

- `tool_aget_joke() -> str`
- `tool_aget_joke_by_id(joke_id: int) -> str`
- `tool_aget_joke_by_type(joke_type: Literal["general", "knock-knock", "programming", "dad"]) -> str`

## Scripts

No custom `pyproject.toml` scripts are defined. Use the following commands directly:

- Install dependencies: `uv sync` or `pip install -e .`
- Run server: `uv run python main.py` or `python main.py`

Dev extras (tests/coverage):

- With uv: `uv sync --extra dev`
- With pip/venv: `pip install -e .[dev]`

## Tests

This repository uses `pytest`. A configuration file `pytest.ini` is provided with coverage reporting.

With uv:

```
uv sync --extra dev
uv run -m pytest -q
```

With pip/venv:

```
pip install -e .[dev]
pytest -q
```

## Probar con MCP Inspector (stdio y http)

El Inspector de MCP permite explorar e invocar las herramientas del servidor de forma interactiva. Necesitas Node.js 18+ para usar `npx`.

Instalar/usar (no se instala permanentemente):

```
npx @modelcontextprotocol/inspector@latest --help
```

### Opción A: Conexión por stdio (proceso hijo)

Ejecuta el Inspector lanzando este servidor como subproceso. Pasa las variables de entorno requeridas con `--env`.

- Con uv:

```
npx @modelcontextprotocol/inspector@latest \
  --command "uv run python main.py" \
  --env API_BASE_URL=https://official-joke-api.appspot.com \
  --env MCP_PROTOCOL=stdio
```

- Con pip/venv:

```
npx @modelcontextprotocol/inspector@latest \
  --command "python main.py" \
  --env API_BASE_URL=https://official-joke-api.appspot.com \
  --env MCP_PROTOCOL=stdio
```

Notas:

- `--command` debe ser el comando que inicia el servidor (idéntico a los ejemplos de la sección Run).
- Puedes añadir más `--env CLAVE=valor` si cambias configuración (p. ej., logging).

### Opción B: Conexión por HTTP (servidor ya levantado)

En este modo el Inspector se conecta a un servidor MCP ya corriendo sobre HTTP (FastMCP "streamable-http"). Usa dos terminales.

1) Terminal 1 — arrancar el servidor HTTP:

```
API_BASE_URL=https://official-joke-api.appspot.com \
MCP_PROTOCOL=http \
MCP_SERVER_HOST=127.0.0.1 \
MCP_SERVER_PORT=8000 \
uv run python main.py
```

Equivalente con pip/venv:

```
API_BASE_URL=https://official-joke-api.appspot.com \
MCP_PROTOCOL=http \
MCP_SERVER_HOST=127.0.0.1 \
MCP_SERVER_PORT=8000 \
python main.py
```

2) Terminal 2 — conectar el Inspector al servidor HTTP:

```
npx @modelcontextprotocol/inspector@latest --server-url http://127.0.0.1:8000
```

Si cambiaste `MCP_SERVER_HOST/PORT`, ajusta la URL. El Inspector detectará el transporte HTTP automáticamente.

### Qué probar en el Inspector

Una vez conectado, deberías ver las herramientas registradas (`tool_get_joke`, `tool_get_joke_by_id`, `tool_get_joke_by_type`, etc.).

Sugerencias rápidas:

- Ejecuta `tool_get_consistent_joke` para una verificación sin red.
- Ejecuta `tool_get_joke` para un chiste aleatorio (requiere `API_BASE_URL`).
- Ejecuta `tool_get_joke_by_id` con `joke_id=42`.
- Ejecuta `tool_get_joke_by_type` con `joke_type="general"`.

Si recibes errores de conexión o timeouts, verifica que `API_BASE_URL` esté definido y accesible, y que el transporte (stdio/http) coincida con cómo iniciaste el servidor/Inspector.

Coverage HTML is written to `htmlcov/` (configured in `pytest.ini`).

Notes:

- The suite is designed to run offline; network calls are mocked where needed.
- Ensure `API_BASE_URL` is set before importing request modules in ad‑hoc scripts (tests patch/marshal config as needed).
- HTTPX mocking options for local development:
  - `respx` (preferred; router-style mocking)
  - `pytest-httpx` (fixture-based)

Focused subsets:

- Single file: `pytest -q tests/test_factory.py`
- Single test: `pytest -q tests/test_factory.py::test_http_repository_is_default`
- Keyword match: `pytest -q -k http`

Quick smoke test (pure function, no network):

```
python -c "from utils.formatters import extract_joke; print(extract_joke({'setup':'Why?','punchline':'Because.'}))"
# Output:
# Why?
# Because.
```

## Design Patterns

This project implements several design patterns for clean, maintainable, and extensible code:

### Repository Pattern (`repositories/`)
- **Purpose**: Abstract data access layer for jokes
- **Components**:
  - `JokeRepository` (abstract base)
  - `HTTPJokeRepository` (HTTP API implementation)
  - `CachedJokeRepository` (decorator with TTL caching)
  - `RepositoryFactory` (creates appropriate repositories)
- **Documentation**: See `docs/REPOSITORY_PATTERN_SUMMARY.md`

### Strategy Pattern (`strategies/`)
- **Purpose**: Flexible MCP transport selection (stdio/HTTP/SSE)
- **Components**:
  - `TransportStrategy` (abstract base)
  - `StdioTransportStrategy`, `HttpTransportStrategy`, `SseTransportStrategy`
  - `TransportStrategyFactory` (creates strategies based on config)
  - `TransportConfig` (immutable configuration)
- **Benefits**:
  - Easy transport switching via `MCP_PROTOCOL` env var
  - Port availability validation before server starts
  - Extensible for new transport types
- **Documentation**: See `docs/TRANSPORT_STRATEGY_PATTERN.md`

### Other Patterns
- **Template Method** (`utils/RequestAPIJokes.py`): Centralized HTTP request handling
- **Singleton** (`utils/config.py`): Single Settings instance via metaclass
- **Decorator** (`repositories/cached_repository.py`): Transparent caching layer
- **Factory** (`repositories/factory.py`, `strategies/factory.py`): Object creation abstraction

For detailed architecture diagrams and implementation guides, see the `docs/` directory.

Further documentation:

- `docs/README.md` (documentation index)
- `docs/TESTING_GUIDE.md`
- `docs/TRANSPORT_STRATEGY_PATTERN.md`
- `docs/REPOSITORY_ARCHITECTURE.md`
- `docs/C4_ARCHITECTURE.md`
- `docs/ARCHITECTURE_DIAGRAM.md`

## Documentation and Changelog

- Full documentation lives under `docs/`. Start at `docs/README.md`.
- Changelog is maintained at `docs/CHANGELOG.md` using Keep a Changelog and SemVer.

## License

This project is licensed under the GNU General Public License v3.0 (GPL-3.0). See the `LICENSE` file for details.

## Status and Verification

- Verified setup and tests on 2025-11-15 (local environment).

## Docker Support

The project includes full Docker support with multi-stage builds and Docker Compose configurations.

### Quick Start with Docker

```bash
# Run with HTTP transport (default)
docker compose up mcp-server-http

# Run with SSE transport
docker compose --profile sse up mcp-server-sse

# Run in background
docker compose up -d mcp-server-http
```

For detailed Docker instructions, see [DOCKER.md](DOCKER.md).

## Code Quality Tools

The project uses the following tools for code quality:

- **Ruff**: Fast Python linter and formatter
- **Black**: Code formatter for consistent style
- **mypy**: Static type checker

### Running Quality Checks Locally

```bash
# Install dev dependencies
uv sync --extra dev

# Run Ruff linter
uv run ruff check .

# Run Ruff formatter
uv run ruff format .

# Run Black formatter
uv run black .

# Run mypy type checker
uv run mypy .
```

### CI/CD

GitHub Actions automatically validates code quality on every push and pull request. The workflow includes:

- Ruff linting and formatting checks
- Black formatting validation
- mypy type checking
- pytest test suite with coverage
- Docker image building

See `.github/workflows/ci.yml` for the complete CI configuration.

## TODOs

- Sync package version in `pyproject.toml` (currently `0.1.0`) with the latest entry in `docs/CHANGELOG.md` (e.g., `0.2.x`).

## Troubleshooting

- If you see errors fetching jokes, verify `API_BASE_URL` is set correctly and reachable.
- Logs are written to `logs/mcp_server.log` by default. Adjust via `LOG_FILE`, `LOG_LEVEL`, `LOG_ROTATION`, and `LOG_RETENTION`.
- For tests that assert logging, prefer in‑memory sinks (e.g., configure `loguru` to stderr) to avoid writing to `logs/`.

## Acknowledgements

- [FastMCP](https://pypi.org/project/fastmcp/) for the MCP server framework.
- Jokes API: https://official-joke-api.appspot.com (public example provider).