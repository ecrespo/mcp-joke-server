services:
  # MCP server with HTTP transport (default)
  mcp-server-http:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-joke-server-http
    ports:
      - "8000:8000"
    environment:
      - API_BASE_URL=https://official-joke-api.appspot.com
      - MCP_PROTOCOL=http
      - MCP_SERVER_HOST=0.0.0.0
      - MCP_SERVER_PORT=8000
      - LOCAL_TOKEN=${LOCAL_TOKEN:--KB6aoXeiF-Qjor3LSEGh4-OOdJLCYrs5uqvUO9NCys}
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/mcp_server.log
      - LOG_ROTATION=10 MB
      - LOG_RETENTION=7 days
    volumes:
      # Mount logs directory for persistence
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp-network

  # MCP server with SSE transport
  mcp-server-sse:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-joke-server-sse
    ports:
      - "8001:8001"
    environment:
      - API_BASE_URL=https://official-joke-api.appspot.com
      - MCP_PROTOCOL=sse
      - MCP_SERVER_HOST=0.0.0.0
      - MCP_SERVER_PORT=8001
      - LOCAL_TOKEN=${LOCAL_TOKEN:--KB6aoXeiF-Qjor3LSEGh4-OOdJLCYrs5uqvUO9NCys}
      - LOG_LEVEL=INFO
      - LOG_FILE=logs/mcp_server.log
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - mcp-network
    profiles:
      - sse

  # MCP server with stdio transport (for development/testing)
  mcp-server-stdio:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-joke-server-stdio
    environment:
      - API_BASE_URL=https://official-joke-api.appspot.com
      - MCP_PROTOCOL=stdio
      - LOCAL_TOKEN=${LOCAL_TOKEN:--KB6aoXeiF-Qjor3LSEGh4-OOdJLCYrs5uqvUO9NCys}
      - LOG_LEVEL=DEBUG
      - LOG_FILE=logs/mcp_server.log
    volumes:
      - ./logs:/app/logs
    restart: "no"
    stdin_open: true
    tty: true
    networks:
      - mcp-network
    profiles:
      - stdio

networks:
  mcp-network:
    driver: bridge
