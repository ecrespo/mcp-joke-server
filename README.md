# mcp-joke-server

Simple Model Context Protocol (MCP) tools server that exposes joke-related tools. It fetches jokes from an external HTTP API and provides them to MCP-compatible clients via the FastMCP framework over stdio.

## Overview

This repository implements an MCP server using `fastmcp`. The server defines four tools:

- `tool_get_consistent_joke()` — returns the same hardcoded joke every time.
- `tool_get_joke()` — fetches a random joke from an external jokes API.
- `tool_get_joke_by_id(joke_id)` — fetches a joke by numeric ID.
- `tool_get_joke_by_type(joke_type)` — fetches a joke by category (`general`, `knock-knock`, `programming`, `dad`).

The external API base URL is configured via the `API_BASE_URL` environment variable (see Environment Variables).

## Stack

- Language: Python (requires Python 3.13+ per `pyproject.toml`)
- MCP framework: `fastmcp`
- HTTP client: `httpx`
- Models/validation: `pydantic`, `pydantic-settings`, and `dataclasses`
- Logging/UX: `loguru` and `rich`
- Package manager: `uv` (detected via `uv.lock`) — `pip` works too

## Requirements

- Python 3.13 or newer
- `uv` (recommended) or `pip`
- Network access to the configured jokes API (`API_BASE_URL`)

## Project Structure

```
.
├── LICENSE
├── README.md
├── main.py                     # MCP server entry point (starts FastMCP)
├── pyproject.toml              # Project metadata and dependencies
├── uv.lock                     # uv lockfile
├── repositories/               # Repository pattern (HTTP + cached repositories)
│   ├── base.py
│   ├── cached_repository.py
│   ├── factory.py
│   ├── http_repository.py
│   └── __init__.py
├── utils/
│   ├── RequestAPIJokes.py      # HTTP client for the jokes API
│   ├── config.py               # Configuration via pydantic-settings
│   ├── constants.py            # URL, joke types, consistent joke
│   ├── exceptions.py
│   ├── formatters.py           # helpers (e.g., extract_joke)
│   ├── logger.py
│   └── model.py                # dataclasses for Joke/Jokes
├── tests/                      # Pytest suite and config
│   ├── conftest.py
│   ├── test_cached_repository.py
│   ├── test_config.py
│   ├── test_exceptions.py
│   ├── test_factory.py
│   ├── test_integration.py
│   └── test_repositories_base.py
├── docs/                       # Documentation index and guides
├── examples/
├── logs/
│   ├── mcp_server.log          # runtime log (default)
│   └── errors.log              # optional error logs
└── htmlcov/                    # coverage HTML report (generated by pytest-cov)
```

## Environment Variables

Configuration is loaded using `pydantic-settings` and supports `.env` files.

Required:

- `API_BASE_URL` — Base URL of the jokes API.
  - Canonical example provider: `https://official-joke-api.appspot.com`
  - Endpoints used by `utils/RequestAPIJokes.py`:
    - `/random_joke`
    - `/random_ten`
    - `/jokes/{id}`
    - `/jokes/{type}/random`

Optional (defaults defined in `utils/config.py`):

- `MCP_SERVER_HOST` (default: `0.0.0.0`) — placeholder for potential non-stdio transports
- `MCP_SERVER_PORT` (default: `8000`) — placeholder for potential non-stdio transports
- `LOG_LEVEL` (default: `INFO`)
- `LOG_FILE` (default: `logs/mcp_server.log`)
- `LOG_ROTATION` (default: `10 MB`)
- `LOG_RETENTION` (default: `7 days`)
- `SESSION_TIMEOUT` (default: `3600`)
- `SESSION_CLEANUP_INTERVAL` (default: `300`)

Example `.env`:

```
API_BASE_URL=https://official-joke-api.appspot.com
LOG_LEVEL=INFO
```

## Setup

Using uv (recommended):

```
uv sync
```

Or with pip:

```
python -m venv .venv
. .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -e .
```

## Run

The server entry point is `main.py` which starts FastMCP via `mcp.run()`.

Using uv:

```
uv run python main.py
```

Using pip/venv:

```
python main.py
```

Notes:

- `fastmcp` typically serves MCP over stdio for MCP-compatible clients. If you intend to connect from an MCP client (e.g., editors or AI assistants that support MCP), configure the client to launch this repository via the run command above.
- TODO: Add a concrete example and client configuration snippet for a specific MCP client.

## Available Tools (MCP)

Defined in `main.py`:

- `tool_get_consistent_joke() -> str`
- `tool_get_joke() -> str`
- `tool_get_joke_by_id(joke_id: int) -> str` (valid range 1–451)
- `tool_get_joke_by_type(joke_type: Literal["general", "knock-knock", "programming", "dad"]) -> str`

Implementation delegates to `repositories/*` and `utils/RequestAPIJokes.py`, then formats with `utils/formatters.extract_joke`.

## Scripts

No custom `pyproject.toml` scripts are defined. Use the following commands directly:

- Install dependencies: `uv sync` or `pip install -e .`
- Run server: `uv run python main.py` or `python main.py`

## Tests

This repository uses `pytest`. A configuration file `pytest.ini` is provided with coverage reporting.

With uv:

```
uv sync --extra dev
uv run -m pytest -q
```

With pip/venv:

```
pip install -e .[dev]
pytest -q
```

Coverage HTML is written to `htmlcov/` (configured in `pytest.ini`).

Notes:

- Some tests may rely on network unless you mock HTTP; prefer running offline by mocking endpoints.
- Ensure `API_BASE_URL` is set in the environment before importing networked modules in ad-hoc scripts.

## Troubleshooting

- If you see errors fetching jokes, verify `API_BASE_URL` is set correctly and reachable.
- Logs are written to `logs/mcp_server.log` by default. Adjust via `LOG_FILE` and `LOG_LEVEL` in your environment.

## License

This project is licensed under the GNU General Public License v3.0 — see the `LICENSE` file for details.

## Acknowledgements

- [FastMCP](https://pypi.org/project/fastmcp/) for the MCP server framework.
- The external jokes API (document exact source as a TODO once confirmed).