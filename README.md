# mcp-joke-server

Simple Model Context Protocol (MCP) tools server that exposes joke-related tools. It fetches jokes from an external HTTP API and provides them to MCP-compatible clients via the FastMCP framework, supporting stdio and an optional HTTP transport.

## Overview

This repository implements an MCP server using `fastmcp`. The server defines four tools:

- `tool_get_consistent_joke()` — returns the same hardcoded joke every time.
- `tool_get_joke()` — fetches a random joke from an external jokes API.
- `tool_get_joke_by_id(joke_id)` — fetches a joke by numeric ID.
- `tool_get_joke_by_type(joke_type)` — fetches a joke by category (`general`, `knock-knock`, `programming`, `dad`).

The external API base URL is configured via the `API_BASE_URL` environment variable (see Environment Variables). The server transport is selected with `MCP_PROTOCOL` (`stdio` or `http`).

## Stack

- Language: Python (requires Python 3.13+ per `pyproject.toml`)
- MCP framework: `fastmcp`
- HTTP client: `httpx`
- Models/validation: `pydantic`, `pydantic-settings`, and `dataclasses`
- Env loading: `python-decouple`
- Logging/UX: `loguru` and `rich`
- Package manager: `uv` (detected via `uv.lock`) — `pip` works too

## Requirements

- Python 3.13 or newer
- `uv` (recommended) or `pip`
- Network access to the configured jokes API (`API_BASE_URL`)

## Project Structure

```
.
├── LICENSE
├── README.md
├── main.py                     # MCP server entry point (starts FastMCP)
├── pyproject.toml              # Project metadata and dependencies
├── uv.lock                     # uv lockfile
├── repositories/               # Repository pattern (HTTP + cached repositories)
│   ├── base.py
│   ├── cached_repository.py
│   ├── factory.py
│   ├── http_repository.py
│   └── __init__.py
├── utils/
│   ├── RequestAPIJokes.py      # HTTP client for the jokes API
│   ├── config.py               # Configuration via pydantic-settings
│   ├── constants.py            # URL, joke types, consistent joke
│   ├── exceptions.py
│   ├── formatters.py           # helpers (e.g., extract_joke)
│   ├── logger.py
│   ├── logging_config.py       # logging formatter/handlers configuration helpers
│   ├── logging_interfaces.py   # protocol-style interfaces for logging plumbing
│   ├── rich_renderers.py       # rich render helpers
│   └── model.py                # dataclasses for Joke/Jokes
├── tests/                      # Pytest suite and config
│   ├── conftest.py
│   ├── test_cached_repository.py
│   ├── test_config.py
│   ├── test_exceptions.py
│   ├── test_factory.py
│   ├── test_integration.py
│   ├── test_main_tools.py
│   └── test_repositories_base.py
├── docs/                       # Documentation index and guides
│   ├── TESTING_GUIDE.md
│   ├── REPOSITORY_ARCHITECTURE.md
│   └── ...
├── examples/
│   ├── mcp_client.py           # demo MCP client
│   └── repository_pattern_demo.py
├── logs/
│   ├── mcp_server.log          # runtime log (default)
│   └── errors.log              # optional error logs
└── htmlcov/                    # coverage HTML report (generated by pytest-cov)
```

## Environment Variables

Configuration is loaded using `pydantic-settings` and supports `.env` files.

Required:

- `API_BASE_URL` — Base URL of the jokes API.
  - Canonical example provider: `https://official-joke-api.appspot.com`
  - Endpoints used by `utils/RequestAPIJokes.py`:
    - `/random_joke`
    - `/random_ten`
    - `/jokes/{id}`
    - `/jokes/{type}/random`

Optional (defaults defined in `utils/config.py`):

- `MCP_PROTOCOL` (default: `http`) — transport selection for the MCP server; accepted values: `stdio` or `http`
- `MCP_SERVER_HOST` (default: `0.0.0.0`) — host for HTTP transport
- `MCP_SERVER_PORT` (default: `8000`) — port for HTTP transport
- `LOG_LEVEL` (default: `INFO`)
- `LOG_FILE` (default: `logs/mcp_server.log`)
- `LOG_ROTATION` (default: `10 MB`)
- `LOG_RETENTION` (default: `7 days`)
- `SESSION_TIMEOUT` (default: `3600`)
- `SESSION_CLEANUP_INTERVAL` (default: `300`)

Example `.env`:

```
API_BASE_URL=https://official-joke-api.appspot.com
MCP_PROTOCOL=http  # use "stdio" to run over stdio
LOG_LEVEL=INFO
```

Notes about configuration:

- `utils/constants.py` binds `URL = Settings.API_BASE_URL` at import time. Ensure the `API_BASE_URL` environment variable is set before importing modules that rely on it (e.g., in tests and ad‑hoc scripts).
- `Settings` in `utils/config.py` loads values from environment variables and `.env` files using `pydantic-settings` and `python-decouple`.

## Setup

Using uv (recommended):

```
uv sync
```

Or with pip:

```
python -m venv .venv
. .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -e .
```

## Run

The server entry point is `main.py`. Transport is selected by `MCP_PROTOCOL`:

- `stdio` (default for many MCP clients): runs MCP over stdio
- `http`: runs MCP over FastMCP's `streamable-http` transport

Using uv (stdio):

```
MCP_PROTOCOL=stdio uv run python main.py
```

Using uv (HTTP):

```
MCP_PROTOCOL=http uv run python main.py  # uses Settings.MCP_SERVER_HOST/PORT
```

Using pip/venv:

```
# stdio
MCP_PROTOCOL=stdio python main.py

# http
MCP_PROTOCOL=http python main.py
```

Notes:

- For stdio, configure your MCP client to launch the command above as a subprocess.
- For HTTP, the server will bind to `MCP_SERVER_HOST:MCP_SERVER_PORT` using FastMCP's `streamable-http` transport.

## Available Tools (MCP)

Defined in `main.py`:

- `tool_get_consistent_joke() -> str`
- `tool_get_joke() -> str`
- `tool_get_joke_by_id(joke_id: int) -> str` (valid range 1–451)
- `tool_get_joke_by_type(joke_type: Literal["general", "knock-knock", "programming", "dad"]) -> str`

Implementation uses the Repository Pattern (`repositories/*`). HTTP access and error mapping live in `utils/RequestAPIJokes.py`, and results are formatted with `utils/formatters.extract_joke`.

Repository defaults:

- The factory (`repositories/factory.py`) returns a cached repository by default for better performance. You can swap implementations without changing tool code.

## Scripts

No custom `pyproject.toml` scripts are defined. Use the following commands directly:

- Install dependencies: `uv sync` or `pip install -e .`
- Run server: `uv run python main.py` or `python main.py`

Dev extras (tests/coverage):

- With uv: `uv sync --extra dev`
- With pip/venv: `pip install -e .[dev]`

## Tests

This repository uses `pytest`. A configuration file `pytest.ini` is provided with coverage reporting.

With uv:

```
uv sync --extra dev
uv run -m pytest -q
```

With pip/venv:

```
pip install -e .[dev]
pytest -q
```

Coverage HTML is written to `htmlcov/` (configured in `pytest.ini`).

Notes:

- The suite is designed to run offline; network calls are mocked where needed.
- Ensure `API_BASE_URL` is set before importing request modules in ad‑hoc scripts (tests patch/marshal config as needed).
- HTTPX mocking options for local development:
  - `respx` (preferred; router-style mocking)
  - `pytest-httpx` (fixture-based)

Quick smoke test (pure function, no network):

```
python -c "from utils.formatters import extract_joke; print(extract_joke({'setup':'Why?','punchline':'Because.'}))"
# Output:
# Why?
# Because.
```

## Troubleshooting

- If you see errors fetching jokes, verify `API_BASE_URL` is set correctly and reachable.
- Logs are written to `logs/mcp_server.log` by default. Adjust via `LOG_FILE`, `LOG_LEVEL`, `LOG_ROTATION`, and `LOG_RETENTION`.
- For tests that assert logging, prefer in‑memory sinks (e.g., configure `loguru` to stderr) to avoid writing to `logs/`.

## License

This project is licensed under the GNU General Public License v3.0 — see the `LICENSE` file for details.

## Acknowledgements

- [FastMCP](https://pypi.org/project/fastmcp/) for the MCP server framework.
- The external jokes API (TODO: document the exact source and attribution once confirmed; typical base is https://official-joke-api.appspot.com).